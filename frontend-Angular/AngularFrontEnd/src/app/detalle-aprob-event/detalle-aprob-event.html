<div class="container detalle-evento-container mt-4">
  <div class="row">
    <div class="col-12 mb-3">
      <button class="btn btn-outline-secondary" (click)="back()">
        <i class="ri-arrow-left-line"></i> Volver
      </button>
    </div>
  </div>

  <div *ngIf="loading" class="text-center py-4">Cargando detalles del evento...</div>
  <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

  <div *ngIf="!loading && evento" class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <h4 class="card-title mb-0">{{ evento.titulo }}</h4>
            <small *ngIf="organizerInfo" class="text-muted">{{ organizerInfo.nombre }} — {{ organizerInfo.correo }}</small>
            <small *ngIf="!organizerInfo" class="text-muted">Organizador ID: {{ evento.idOrganizador }}</small>
          </div>
          <div>
            <span [ngClass]="{
                'badge bg-secondary': evento.estado === 'Borrador',
                'badge bg-warning text-dark': evento.estado === 'Pendiente',
                'badge bg-success': evento.estado === 'Aprobado',
                'badge bg-danger': evento.estado === 'Rechazado'
              }" class="py-2 px-3">{{ evento.estado }}</span>
          </div>
        </div>
        <div class="card-body">
          <div *ngIf="organizerInfo" class="mb-3">
            <h5>Organizador</h5>
            <p class="mb-1"><strong>Nombre:</strong> {{ organizerInfo.nombre }}</p>
            <p class="mb-1"><strong>Correo:</strong> {{ organizerInfo.correo }}</p>
            <div *ngIf="organizerInfo.cargo || organizerInfo.facultad || organizerInfo.docente" class="mb-1">
              <!-- Parece ser un docente (campo plano o anidado en `docente`) -->
              <p class="mb-0"><strong>Cargo:</strong> {{ organizerInfo.cargo || organizerInfo.docente?.cargo || '—' }}</p>
              <p class="mb-0"><strong>Facultad:</strong> {{ organizerInfo.facultad || organizerInfo.docente?.facultad || '—' }}</p>
              <p class="mb-0"><strong>Unidad académica:</strong> {{ organizerInfo.unidadAcademica || organizerInfo.docente?.unidadAcademica || '—' }}</p>
            </div>
            <div *ngIf="organizerInfo.codigoEstudiantil || organizerInfo.programa || organizerInfo.estudiante" class="mb-1">
              <!-- Parece ser un estudiante (campo plano o anidado en `estudiante`) -->
              <p class="mb-0"><strong>Código estudiantil:</strong> {{ organizerInfo.codigoEstudiantil || organizerInfo.estudiante?.codigoEstudiantil || '—' }}</p>
              <p class="mb-0"><strong>Programa:</strong> {{ organizerInfo.programa || organizerInfo.estudiante?.programa || '—' }}</p>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <ul class="list-group list-group-flush mb-3">
                <li class="list-group-item"><strong>Tipo:</strong> {{ evento.tipoEvento }}</li>
                <li class="list-group-item"><strong>Fecha:</strong> {{ evento.fecha }}</li>
                <li class="list-group-item"><strong>Horarios:</strong> {{ formatTimeSlots(evento) }}</li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="list-group list-group-flush mb-3">
                <li class="list-group-item">
                  <strong>Instalaciones:</strong>
                  <ul class="mb-0">
                    <li *ngFor="let inst of evento.instalaciones">
                      <strong>{{ inst.nombreInstalacion || 'Instalación ' + inst.idInstalacion }}</strong> — 
                      {{ inst.tipoInstalacion || 'Sin tipo' }} • 
                      Capacidad: {{ inst.capacidadInstalacion || '—' }} • 
                      {{ (inst.horaInicio ? inst.horaInicio.substring(0,5) : '--:--') }} - {{ (inst.horaFin ? inst.horaFin.substring(0,5) : '--:--') }}
                    </li>
                    <li *ngIf="!evento.instalaciones || evento.instalaciones.length === 0" class="text-muted">No hay instalaciones</li>
                  </ul>
                </li>
              </ul>
            </div>
          </div>

          <div class="mb-3">
            <h5>Organizadores y Avales</h5>
            <div *ngIf="organizadoresDetallados.length === 0" class="text-muted">
              No hay información de organizadores con avales
            </div>
            <div *ngFor="let org of organizadoresDetallados" class="card mb-2">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="mb-2">
                      <span class="badge bg-primary">{{ org.rol }}</span>
                      {{ org.usuario?.nombre || 'Cargando...' }}
                    </h6>
                    <p class="mb-1"><strong>Correo:</strong> {{ org.usuario?.correo || '—' }}</p>
                    
                    <!-- Información de estudiante -->
                    <div *ngIf="org.usuario?.codigoEstudiantil || org.usuario?.programa || org.usuario?.estudiante">
                      <p class="mb-0"><strong>Código:</strong> {{ org.usuario?.codigoEstudiantil || org.usuario?.estudiante?.codigoEstudiantil || '—' }}</p>
                      <p class="mb-0"><strong>Programa:</strong> {{ org.usuario?.programa || org.usuario?.estudiante?.programa || '—' }}</p>
                    </div>
                    
                    <!-- Información de docente -->
                    <div *ngIf="org.usuario?.cargo || org.usuario?.unidadAcademica || org.usuario?.docente">
                      <p class="mb-0"><strong>Cargo:</strong> {{ org.usuario?.cargo || org.usuario?.docente?.cargo || '—' }}</p>
                      <p class="mb-0"><strong>Unidad Académica:</strong> {{ org.usuario?.unidadAcademica || org.usuario?.docente?.unidadAcademica || '—' }}</p>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <p class="mb-1"><strong>Tipo de Aval:</strong> {{ org.tipoAval || '—' }}</p>
                    <button *ngIf="org.avalPdf" class="btn btn-sm btn-outline-primary" (click)="openPdf(org.avalPdf)">
                      <i class="ri-file-pdf-line"></i> Ver/Descargar Aval
                    </button>
                    <span *ngIf="!org.avalPdf" class="text-muted">Sin aval</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="(participacionesDetailed || []).length">
            <h5>Participaciones Organizaciones Externas</h5>
            <div class="list-group">
              <div *ngFor="let pd of participacionesDetailed" class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                  <div>
                    <h6 class="mb-1">{{ pd.org?.nombre || pd.original.nombreOrganizacion || ('ID ' + pd.original.idOrganizacion) }}</h6>
                    <small class="text-muted">NIT: {{ pd.org?.nit || '—' }}</small>
                  </div>
                  <div>
                    <button *ngIf="pd.original.certificadoPdf" class="btn btn-sm btn-outline-primary" (click)="openPdf(pd.original.certificadoPdf)">Ver PDF</button>
                  </div>
                </div>

                <p class="mb-1">Certificado: <span class="text-break">{{ pd.original.certificadoPdf || '—' }}</span></p>

                <div class="mt-2">
                  <strong>Representante:</strong>
                  <div *ngIf="pd.original.representanteDiferente">
                    <p class="mb-0"> Asiste un representante diferente: {{ pd.original.nombreRepresentanteDiferente || 'Datos no proporcionados' }}</p>
                  </div>
                  <div *ngIf="!pd.original.representanteDiferente">
                    <p class="mb-0">Asiste el representante legal: {{ pd.org?.representanteLegal || '—' }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones de evaluación -->
          <div *ngIf="canEvaluate()" class="mt-4 d-flex gap-3 justify-content-end">
            <button class="btn btn-success" (click)="openApproveModal()">
              <i class="ri-check-line"></i> Aprobar Evento
            </button>
            <button class="btn btn-danger" (click)="openRejectModal()">
              <i class="ri-close-line"></i> Rechazar Evento
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Aprobación -->
<div class="modal fade" [class.show]="showApproveModal" [style.display]="showApproveModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Aprobar Evento</h5>
        <button type="button" class="btn-close" (click)="closeApproveModal()" [disabled]="submittingEvaluation"></button>
      </div>
      <div class="modal-body">
        <p><strong>{{ evento?.titulo }}</strong></p>
        <p class="text-muted">Para aprobar este evento, debe adjuntar el acta del comité en formato PDF.</p>
        
        <div class="mb-3">
          <label for="actaFile" class="form-label">Acta del Comité (PDF) <span class="text-danger">*</span></label>
          <input 
            type="file" 
            class="form-control" 
            id="actaFile"
            accept=".pdf"
            (change)="onActaFileSelected($event)"
            [disabled]="submittingEvaluation">
          <small class="text-muted">Tamaño máximo: 10MB</small>
          <div *ngIf="actaFileName" class="mt-2">
            <span class="badge bg-success">
              <i class="ri-file-pdf-line"></i> {{ actaFileName }}
            </span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeApproveModal()" [disabled]="submittingEvaluation">
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-success" 
          (click)="aprobarEvento()"
          [disabled]="!actaFile || submittingEvaluation">
          <span *ngIf="submittingEvaluation" class="spinner-border spinner-border-sm me-2"></span>
          {{ submittingEvaluation ? 'Aprobando...' : 'Aprobar Evento' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showApproveModal" *ngIf="showApproveModal"></div>

<!-- Modal de Rechazo -->
<div class="modal fade" [class.show]="showRejectModal" [style.display]="showRejectModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Rechazar Evento</h5>
        <button type="button" class="btn-close" (click)="closeRejectModal()" [disabled]="submittingEvaluation"></button>
      </div>
      <div class="modal-body">
        <p><strong>{{ evento?.titulo }}</strong></p>
        <p class="text-muted">Indique una justificación clara para rechazar este evento.</p>
        
        <div class="mb-3">
          <label for="justificacion" class="form-label">Justificación <span class="text-danger">*</span></label>
          <textarea 
            class="form-control" 
            id="justificacion"
            rows="5"
            [(ngModel)]="justificacion"
            placeholder="Escriba la justificación del rechazo..."
            [disabled]="submittingEvaluation"
            maxlength="500"></textarea>
          <small class="text-muted">{{ justificacion.length }}/500 caracteres</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeRejectModal()" [disabled]="submittingEvaluation">
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-danger" 
          (click)="rechazarEvento()"
          [disabled]="!justificacion || justificacion.trim() === '' || submittingEvaluation">
          <span *ngIf="submittingEvaluation" class="spinner-border spinner-border-sm me-2"></span>
          {{ submittingEvaluation ? 'Rechazando...' : 'Rechazar Evento' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showRejectModal" *ngIf="showRejectModal"></div>
