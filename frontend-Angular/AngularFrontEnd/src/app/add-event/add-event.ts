import { Component } from '@angular/core';
import { ReactiveFormsModule, FormBuilder, FormGroup, Validators } from '@angular/forms';
import { CommonModule } from '@angular/common';
import { Router, RouterLink } from '@angular/router';
import { EventService } from '../services/event.service';
import { EventosApiService, EventoDTO } from '../services/eventos.api.service';
import { OrganizacionExternaDTO } from '../services/organizaciones.api.service';
import { UsuarioDTO } from '../services/usuarios.api.service';
import { OrganizacionExternaComponent } from '../components/organizacion-externa/organizacion-externa';
import { SelectedOrganizationsComponent } from '../components/selected-organizations/selected-organizations';
import { UsuarioSelectionComponent } from '../components/usuario-selection/usuario-selection';
import { SelectedUsersComponent } from '../components/selected-users/selected-users';
import { EncountersComponent, Encounter } from '../components/encounters/encounters';

@Component({
  selector: 'app-add-event',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule, RouterLink, OrganizacionExternaComponent, SelectedOrganizationsComponent, UsuarioSelectionComponent, SelectedUsersComponent, EncountersComponent],
  templateUrl: './add-event.html',
  styleUrls: ['./add-event.css']
})
export class AddEventComponent {
  eventForm: FormGroup;
  showOrgModal: boolean = false;
  showUserModal: boolean = false;
  selectedOrganizations: OrganizacionExternaDTO[] = [];
  selectedUsers: UsuarioDTO[] = [];
  encounters: Encounter[] = [];
  selectedFile: File | null = null;
  
  constructor(
    private fb: FormBuilder, 
    private eventService: EventService, 
    private eventosApiService: EventosApiService,
    private router: Router
  ) {
    this.eventForm = this.fb.group({
      eventName: ['', Validators.required],
      eventLocation: ['', Validators.required],
      eventType: ['', Validators.required],
      eventStatus: ['Borrador', Validators.required],
      externalOrgName: [''],
      externalOrgNit: [''],
      externalOrgParticipation: [false],
      // Campos para el backend
      avalPdf: ['', Validators.required],
      tipoAval: ['', Validators.required]
    });
  }


  submitEvent(): void {
    console.log('=== VALIDACI√ìN DEL FORMULARIO DE EVENTO ===');
    console.log('üìã Estado del formulario:', this.eventForm.value);
    console.log('üìã Formulario v√°lido:', this.eventForm.valid);
    console.log('üìã Errores del formulario:', this.eventForm.errors);
    console.log('üìã Encuentros:', this.encounters);
    console.log('üìã Usuarios seleccionados:', this.selectedUsers);
    
    // Validar campos del formulario
    const formErrors = this.validateForm();
    if (formErrors.length > 0) {
      console.error('‚ùå Errores en el formulario:', formErrors);
      formErrors.forEach(error => console.error(`- ${error}`));
      alert('Por favor, complete todos los campos obligatorios.');
      return;
    }

    // Validar encuentros
    if (this.encounters.length === 0) {
      console.error('‚ùå El evento debe tener al menos un encuentro.');
      alert('El evento debe tener al menos un encuentro.');
      return;
    }

    // Validar organizadores
    if (this.selectedUsers.length === 0) {
      console.error('‚ùå El evento debe tener al menos un organizador.');
      alert('El evento debe tener al menos un organizador.');
      return;
    }

    console.log('‚úÖ Validaciones completadas exitosamente');

    // Crear el objeto EventoDTO para el backend
    const eventoData: EventoDTO = this.buildEventoDTO();
    
    console.log('üì§ Enviando evento al backend:', eventoData);

    // Enviar al backend
    this.eventosApiService.create(eventoData).subscribe({
      next: (createdEvent) => {
        console.log('‚úÖ Evento creado exitosamente:', createdEvent);
        alert('Evento creado exitosamente.');
        this.router.navigate(['/home']);
      },
      error: (error) => {
        console.error('‚ùå Error al crear evento:', error);
        alert('Error al crear el evento. Verifique la consola para m√°s detalles.');
      }
    });
  }

  private validateForm(): string[] {
    const errors: string[] = [];
    const form = this.eventForm;

    // Validar campos b√°sicos
    if (!form.get('eventName')?.value?.trim()) {
      errors.push('El t√≠tulo del evento es obligatorio');
    }

    if (!form.get('eventType')?.value) {
      errors.push('El tipo de evento es obligatorio');
    }

    if (!form.get('avalPdf')?.value || form.get('avalPdf')?.value.trim() === '') {
      errors.push('El aval PDF es obligatorio');
    }

    if (!form.get('tipoAval')?.value) {
      errors.push('El tipo de aval es obligatorio');
    }

    // Validar que haya encuentros
    if (this.encounters.length === 0) {
      errors.push('El evento debe tener al menos un encuentro');
    } else {
      // Validar cada encuentro
      this.encounters.forEach((encounter, index) => {
        if (!encounter.date) {
          errors.push(`El encuentro ${index + 1} debe tener una fecha`);
        }
        if (!encounter.startTime) {
          errors.push(`El encuentro ${index + 1} debe tener una hora de inicio`);
        }
        if (!encounter.endTime) {
          errors.push(`El encuentro ${index + 1} debe tener una hora de fin`);
        }
        if (!encounter.location) {
          errors.push(`El encuentro ${index + 1} debe tener una instalaci√≥n`);
        }

        // Validar fechas de encuentros
        if (encounter.date) {
          const fecha = new Date(encounter.date);
          const hoy = new Date();
          hoy.setHours(0, 0, 0, 0);
          
          if (fecha < hoy) {
            errors.push(`La fecha del encuentro ${index + 1} no puede ser en el pasado`);
          }
        }

        // Validar horas de encuentros
        if (encounter.startTime && encounter.endTime) {
          if (encounter.startTime >= encounter.endTime) {
            errors.push(`En el encuentro ${index + 1}, la hora de fin debe ser posterior a la hora de inicio`);
          }
        }
      });
    }

    return errors;
  }

  private buildEventoDTO(): EventoDTO {
    const form = this.eventForm;
    
    // Obtener datos del primer encuentro (fecha, hora inicio, hora fin)
    const primerEncuentro = this.encounters[0];
    
    console.log('üè¢ Construyendo EventoDTO...');
    console.log('üìã Primer encuentro:', primerEncuentro);
    console.log('üè¢ Ubicaci√≥n del encuentro:', primerEncuentro?.location);
    
    // Mapear instalaciones desde los encuentros - solo IDs seg√∫n la estructura especificada
    const instalaciones = this.encounters.map((encounter, index) => {
      const instalacion = {
        idInstalacion: encounter.location?.idInstalacion || 0
      };
      console.log(`üè¢ Instalaci√≥n ${index + 1} ID:`, instalacion.idInstalacion);
      return instalacion;
    });

    // Obtener el primer organizador (el backend espera un solo organizador)
    const organizador = this.selectedUsers[0];
    console.log('üë§ Organizador seleccionado:', organizador);

    // Actualizar eventLocation con el ID de la primera instalaci√≥n
    const primeraInstalacionId = this.encounters[0]?.location?.idInstalacion || 0;
    form.patchValue({ eventLocation: primeraInstalacionId.toString() });
    console.log('üìç EventLocation actualizado con ID de instalaci√≥n:', primeraInstalacionId);

    const eventoData: EventoDTO = {
      titulo: form.get('eventName')?.value,
      tipoEvento: form.get('eventType')?.value === 'academico' ? 'Acad√©mico' : 'L√∫dico',
      fecha: primerEncuentro?.date || '',
      horaInicio: primerEncuentro?.startTime || '',
      horaFin: primerEncuentro?.endTime || '',
      instalaciones: instalaciones,
      organizador: { idUsuario: organizador.idUsuario },
      avalPdf: form.get('avalPdf')?.value,
      tipoAval: form.get('tipoAval')?.value
    };

    console.log('üì§ EventoDTO construido:', eventoData);
    return eventoData;
  }

  cancel(): void {
    this.eventForm.reset();
    this.router.navigate(['/home']);
  }

  openModal(): void {
    this.showOrgModal = true;
  }

  closeOrgModal(): void {
    this.showOrgModal = false;
  }

  openUserModal(): void {
    this.showUserModal = true;
  }

  closeUserModal(): void {
    this.showUserModal = false;
  }

  onOrganizationSelected(organization: OrganizacionExternaDTO): void {
    // Verificar si ya est√° seleccionada
    const isAlreadySelected = this.selectedOrganizations.some(org => org.idOrganizacion === organization.idOrganizacion);
    
    if (!isAlreadySelected) {
      this.selectedOrganizations.push(organization);
      this.updateFormWithSelectedOrganizations();
    }
  }

  onOrganizationRemoved(organization: OrganizacionExternaDTO): void {
    this.selectedOrganizations = this.selectedOrganizations.filter(org => org.idOrganizacion !== organization.idOrganizacion);
    this.updateFormWithSelectedOrganizations();
  }

  private updateFormWithSelectedOrganizations(): void {
    // Actualizar el formulario con las organizaciones seleccionadas
    if (this.selectedOrganizations.length > 0) {
      const firstOrg = this.selectedOrganizations[0];
      this.eventForm.patchValue({
        externalOrgName: firstOrg.nombre,
        externalOrgNit: firstOrg.nit,
        externalOrgParticipation: true
      });
    } else {
      this.eventForm.patchValue({
        externalOrgName: '',
        externalOrgNit: '',
        externalOrgParticipation: false
      });
    }
  }

  onParticipationChange(): void {
    const participation = this.eventForm.get('externalOrgParticipation')?.value;
    if (!participation) {
      this.selectedOrganizations = [];
      this.eventForm.patchValue({
        externalOrgName: '',
        externalOrgNit: ''
      });
    }
  }

  onUserSelected(user: UsuarioDTO): void {
    // Verificar si ya est√° seleccionado
    const isAlreadySelected = this.selectedUsers.some(u => u.idUsuario === user.idUsuario);
    
    if (!isAlreadySelected) {
      this.selectedUsers.push(user);
    }
  }

  onUserRemoved(user: UsuarioDTO): void {
    this.selectedUsers = this.selectedUsers.filter(u => u.idUsuario !== user.idUsuario);
  }

  onEncountersChanged(encounters: Encounter[]): void {
    this.encounters = encounters;
  }

  isFormValid(): boolean {
    // Verificar que el formulario b√°sico sea v√°lido
    const formValid = this.eventForm.valid;
    
    // Verificar que haya encuentros
    const hasEncounters = this.encounters.length > 0;
    
    // Verificar que haya organizadores
    const hasOrganizers = this.selectedUsers.length > 0;
    
    // Verificar que todos los encuentros tengan datos v√°lidos
    const encountersValid = this.encounters.every(encounter => 
      encounter.date && encounter.startTime && encounter.endTime && encounter.location
    );
    
    console.log('üîç Validaci√≥n del formulario:', {
      formValid,
      hasEncounters,
      hasOrganizers,
      encountersValid,
      totalValid: formValid && hasEncounters && hasOrganizers && encountersValid
    });
    
    return formValid && hasEncounters && hasOrganizers && encountersValid;
  }

  onFileSelected(event: any): void {
    const file = event.target.files[0];
    if (file) {
      this.selectedFile = file;
      console.log('üìÑ Archivo seleccionado:', file.name);
      
      // Convertir archivo a Base64
      const reader = new FileReader();
      reader.onload = () => {
        const base64String = reader.result as string;
        // Remover el prefijo "data:application/pdf;base64," si existe
        const base64Data = base64String.split(',')[1] || base64String;
        this.eventForm.patchValue({ avalPdf: base64Data });
        console.log('‚úÖ Archivo convertido a Base64');
        console.log('üìã Valor del campo avalPdf:', this.eventForm.get('avalPdf')?.value);
        console.log('üìã Formulario v√°lido despu√©s de archivo:', this.eventForm.valid);
      };
      reader.readAsDataURL(file);
    } else {
      // Si no hay archivo, limpiar el campo
      this.selectedFile = null;
      this.eventForm.patchValue({ avalPdf: '' });
      console.log('üóëÔ∏è Archivo removido');
    }
  }

}
