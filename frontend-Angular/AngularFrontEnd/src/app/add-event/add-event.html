<header class="headerSec">
  <button type="button" aria-label="Ir al inicio" routerLink="/home">
    <img src="assets/images/logo.jpg" alt="Logo" class="logo-img">
  </button>
  <h1>{{ isEdit ? 'Editar Evento' : 'Nuevo Evento' }}</h1>
  <i class="ri-account-circle-fill" id="perfilBtn" routerLink="/profile-menu"></i>
</header>

<form [formGroup]="eventForm" class="container" novalidate (ngSubmit)="submitEvent()">
  <fieldset class="form-row">
    <legend class="sr-only">Información básica del evento</legend>
    <div class="input-group">
      <label for="eventName">Nombre del evento</label>
      <input type="text" id="eventName" formControlName="eventName" placeholder="Nombre..." required
             [ngClass]="{'is-invalid': eventForm.get('eventName')?.invalid && eventForm.get('eventName')?.touched}">
      <div *ngIf="eventForm.get('eventName')?.hasError('required') && eventForm.get('eventName')?.touched"
           class="invalid-feedback">
        El nombre es obligatorio.
      </div>
      <div *ngIf="eventForm.get('eventName')?.hasError('dangerousContent') && eventForm.get('eventName')?.touched"
           class="invalid-feedback">
        {{ eventForm.get('eventName')?.errors?.['dangerousContent']?.message || 'El nombre contiene caracteres no permitidos.' }}
      </div>
    </div>
  </fieldset>

  <fieldset class="form-row">
    <legend class="sr-only">Fecha del evento</legend>
    <div class="input-group">
      <label for="eventDate">Fecha del evento</label>
      <input type="date" id="eventDate" formControlName="eventDate" required
             [ngClass]="{'is-invalid': eventForm.get('eventDate')?.invalid && eventForm.get('eventDate')?.touched}">
      <div *ngIf="eventForm.get('eventDate')?.hasError('required') && eventForm.get('eventDate')?.touched"
           class="invalid-feedback">
        La fecha del evento es obligatoria.
      </div>
    </div>
  </fieldset>

  <fieldset class="form-row">
    <legend class="sr-only">Tipo de evento</legend>
    <div class="input-group">
      <label for="eventType">Tipo de evento</label>
      <select id="eventType" formControlName="eventType" required
              [ngClass]="{'is-invalid': eventForm.get('eventType')?.invalid && eventForm.get('eventType')?.touched}">
        <option value="" disabled>Seleccione un tipo</option>
        <option value="academico">Académico</option>
        <option value="ludico">Lúdico</option>
      </select>
      <div *ngIf="eventForm.get('eventType')?.hasError('required') && eventForm.get('eventType')?.touched"
           class="invalid-feedback">
        El tipo de evento es obligatorio.
      </div>
    </div>
  </fieldset>

  <!-- Organizadores del evento -->
  <fieldset class="form-row">
    <legend>Organizadores del evento</legend>
    <div class="organizadores-container">
      <div class="organizadores-list">
        <div *ngFor="let org of organizadores; let i = index" class="organizador-card">
          <div class="organizador-header">
            <h4>{{ org.usuario.nombre }}</h4>
            <span class="badge" [ngClass]="{'badge-primary': i === 0, 'badge-secondary': i > 0}">
              {{ i === 0 ? 'Principal' : 'Coorganizador' }}
            </span>
            <span *ngIf="org.requiresAval" class="badge badge-warning">Requiere Aval</span>
            <button *ngIf="i > 0" type="button" class="btn-remove" (click)="removeOrganizer(org.usuario)" 
                    title="Remover organizador">
              ✕
            </button>
          </div>
          <div class="organizador-details">
            <p><small>Tipo: {{ getUsuarioTypeLabel(org.usuario) }}</small></p>
            <p *ngIf="getUsuarioProgramLabel(org.usuario)"><small>Programa: {{ getUsuarioProgramLabel(org.usuario) }}</small></p>
          </div>
          <div *ngIf="org.requiresAval" class="aval-section">
            <label>Aval PDF</label>
            <div class="file-input-wrapper">
              <input type="file" accept=".pdf" (change)="onOrganizerAvalChanged(org, $event)"
                     [ngClass]="{'is-invalid': org.errorMessage}">
              <span *ngIf="org.avalPdf && !org.selectedFile" class="file-name selected">
                ✓ {{ getDisplayedAvalName(org) }}
              </span>
              <span *ngIf="org.selectedFile" class="file-name selected">
                ✓ {{ org.selectedFile.name }}
              </span>
            </div>
            <div *ngIf="org.errorMessage" class="error-message">{{ org.errorMessage }}</div>
            <label>Tipo de aval</label>
            <select (change)="org.tipoAval = $any($event.target).value"
                    [value]="org.tipoAval"
                    [ngClass]="{'is-invalid': org.requiresAval && !org.tipoAval}">
              <option value="">Seleccione tipo de aval</option>
              <option value="Director_Programa">Director de Programa</option>
              <option value="Director_Docencia">Director de Docencia</option>
            </select>
          </div>
          <div *ngIf="!org.requiresAval && i > 0" class="info-message">
            <i class="ri-information-line"></i>
            <span>Este coorganizador utiliza el mismo aval del organizador principal por ser del mismo programa académico.</span>
          </div>
        </div>
      </div>
      <button type="button" class="btn btn-secondary" (click)="openOrganizerModal()">
        + Agregar Organizador
      </button>
    </div>
  </fieldset>

  <!-- Capacidad del evento -->
  <fieldset class="form-row">
    <legend class="sr-only">Capacidad del evento</legend>
    <div class="input-group">
      <label for="eventCapacity">Capacidad esperada del evento</label>
      <input type="number" id="eventCapacity" [(ngModel)]="eventCapacity" [ngModelOptions]="{standalone: true}" 
             placeholder="Número de personas" min="1" required
             (ngModelChange)="onCapacityChange()">
      <small class="form-text">Ingrese el número esperado de asistentes. Las instalaciones seleccionadas deben cubrir esta capacidad.</small>
    </div>
  </fieldset>

  <!-- Módulo de Encuentros -->
  <app-encounters 
    [encounters]="encounters"
    (encountersChanged)="onEncountersChanged($event)">
  </app-encounters>

  <!-- Mensaje de error de tiempos -->
  <div *ngIf="timeError" class="alert alert-danger">
    {{ timeError }}
  </div>

  <fieldset class="form-row form-row--last">
    <legend class="sr-only">Estado</legend>
    <div class="input-group">
      <p class="label-status">Estado del evento</p>
      <p class="status">Borrador</p>
    </div>
  </fieldset>

  <section class="form-grid">
    <fieldset class="external-org">
      <legend>Módulo de organización externa</legend>
      <div class="checkbox-group">
        <input type="checkbox" id="externalOrgParticipation" formControlName="externalOrgParticipation" (change)="onParticipationChange()">
        <label for="externalOrgParticipation">¿Participa una organización externa?</label>
      </div>
      <div class="icon-buttons" *ngIf="eventForm.get('externalOrgParticipation')?.value">
        <button type="button" (click)="openModal()" class="icon-button" aria-label="Abrir listado de organizaciones externas">
          <img src="assets/images/copy.png" alt="Listado de organización externa">
        </button>
      </div>
    </fieldset>

    <!-- Organizaciones seleccionadas -->
    <app-selected-organizations 
      *ngIf="eventForm.get('externalOrgParticipation')?.value && selectedOrganizations.length > 0"
      [selectedOrganizations]="selectedOrganizations"
      [initialOrganizationData]="initialOrgData"
      (organizationRemoved)="onOrganizationRemoved($event)">
    </app-selected-organizations>
    
    <!-- Mensaje cuando no hay organizaciones seleccionadas -->
    <div *ngIf="eventForm.get('externalOrgParticipation')?.value && selectedOrganizations.length === 0" class="no-organizations-selected">
      <p>No hay organizaciones seleccionadas. Haz clic en el botón de arriba para seleccionar organizaciones.</p>
    </div>
  </section>

  <div class="form-actions">
    <button type="submit" class="btn btn-primary" 
      [disabled]="!isFormValid()">
      {{ isEdit ? 'Guardar cambios' : 'Crear' }}
    </button>
    <button type="button" class="btn btn-secondary" (click)="cancel()">Cancelar</button>
  </div>
</form>

<!-- Modal de organizaciones externas -->
<app-organizacion-externa 
  [showModal]="showOrgModal"
  (modalClosed)="closeOrgModal()"
  (organizationSelected)="onOrganizationSelected($event)">
</app-organizacion-externa>

<!-- Modal de selección de organizadores -->
<app-usuario-selection 
  [showModal]="showOrganizerModal"
  [currentUserId]="currentUser?.idUsuario"
  [selectedUsuarios]="modalSelectedUsuarios"
  (modalClosed)="closeOrganizerModal()"
  (usuarioSelected)="onOrganizerSelected($event)">
</app-usuario-selection>
