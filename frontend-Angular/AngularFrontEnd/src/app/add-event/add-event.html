<header class="headerSec">
  <button type="button" aria-label="Ir al inicio" routerLink="/home">
    <img src="assets/images/logo.jpg" alt="Logo" class="logo-img">
  </button>
  <h1>{{ isEdit ? 'Editar Evento' : 'Nuevo Evento' }}</h1>
  <i class="ri-account-circle-fill" id="perfilBtn" routerLink="/profile-menu"></i>
</header>

<form [formGroup]="eventForm" class="container" novalidate (ngSubmit)="submitEvent()">
  <fieldset class="form-row">
    <legend class="sr-only">Información básica del evento</legend>
    <div class="input-group">
      <label for="eventName">Nombre del evento</label>
      <input type="text" id="eventName" formControlName="eventName" placeholder="Nombre..." required
             [ngClass]="{'is-invalid': eventForm.get('eventName')?.invalid && eventForm.get('eventName')?.touched}">
      <div *ngIf="eventForm.get('eventName')?.hasError('required') && eventForm.get('eventName')?.touched"
           class="invalid-feedback">
        El nombre es obligatorio.
      </div>
      <div *ngIf="eventForm.get('eventName')?.hasError('dangerousContent') && eventForm.get('eventName')?.touched"
           class="invalid-feedback">
        {{ eventForm.get('eventName')?.errors?.['dangerousContent']?.message || 'El nombre contiene caracteres no permitidos.' }}
      </div>
    </div>
  </fieldset>

  <fieldset class="form-row">
    <legend class="sr-only">Tipo y responsable</legend>
    <div class="input-group">
      <label for="eventType">Tipo de evento</label>
      <select id="eventType" formControlName="eventType" required
              [ngClass]="{'is-invalid': eventForm.get('eventType')?.invalid && eventForm.get('eventType')?.touched}">
        <option value="" disabled>Seleccione un tipo</option>
        <option value="academico">Académico</option>
        <option value="ludico">Lúdico</option>
      </select>
      <div *ngIf="eventForm.get('eventType')?.hasError('required') && eventForm.get('eventType')?.touched"
           class="invalid-feedback">
        El tipo de evento es obligatorio.
      </div>
    </div>
    <div class="input-group">
      <label>Coorganizadores del evento</label>
      <div class="user-selection-container">
        <button type="button" class="btn btn-secondary" (click)="openUserModal()">
          Seleccionar Coorganizadores
        </button>
        <span *ngIf="selectedUsers.length > 0" class="selected-count">
          {{ selectedUsers.length }} coorganizadores seleccionados
        </span>
      </div>
    </div>
  </fieldset>


  <fieldset class="form-row">
    <legend class="sr-only">Aval del evento</legend>
    <div class="input-group">
      <label for="avalPdf">Aval PDF</label>
      <input type="file" id="avalPdf" (change)="onFileSelected($event)" accept=".pdf" required
             [ngClass]="{'is-invalid': eventForm.get('avalPdf')?.invalid && eventForm.get('avalPdf')?.touched}">
      <div *ngIf="eventForm.get('avalPdf')?.hasError('required') && eventForm.get('avalPdf')?.touched"
           class="invalid-feedback">
        El aval PDF es obligatorio.
      </div>
      <div *ngIf="getDisplayedAvalName()" class="file-info">
        <span>Archivo seleccionado: {{ getDisplayedAvalName() }}</span>
      </div>
    </div>
    <div class="input-group">
      <label for="tipoAval">Tipo de aval</label>
      <select id="tipoAval" formControlName="tipoAval" required
              [ngClass]="{'is-invalid': eventForm.get('tipoAval')?.invalid && eventForm.get('tipoAval')?.touched}">
        <option value="" disabled>Seleccione un tipo de aval</option>
        <option value="Director_Programa">Director de Programa</option>
        <option value="Director_Docencia">Director de Docencia</option>
      </select>
      <div *ngIf="eventForm.get('tipoAval')?.hasError('required') && eventForm.get('tipoAval')?.touched"
           class="invalid-feedback">
        El tipo de aval es obligatorio.
      </div>
    </div>
  </fieldset>

  <!-- Organizadores seleccionados -->
  <app-selected-users 
    [selectedUsers]="selectedUsers"
    (userRemoved)="onUserRemoved($event)">
  </app-selected-users>

  <!-- Módulo de Encuentros -->
  <app-encounters 
    [encounters]="encounters"
    (encountersChanged)="onEncountersChanged($event)">
  </app-encounters>

  <fieldset class="form-row form-row--last">
    <legend class="sr-only">Estado</legend>
    <div class="input-group">
      <p class="label-status">Estado del evento</p>
      <p class="status"> Borrador </p>
    </div>
  </fieldset>

  <section class="form-grid">

    <fieldset class="external-org">
      <legend>Módulo de organización externa</legend>
      <div class="checkbox-group">
        <input type="checkbox" id="externalOrgParticipation" formControlName="externalOrgParticipation" (change)="onParticipationChange()">
        <label for="externalOrgParticipation">¿Participa una organización externa?</label>
      </div>
      <div class="icon-buttons" *ngIf="eventForm.get('externalOrgParticipation')?.value">
        <button type="button" (click)="openModal()" class="icon-button" aria-label="Abrir listado de organizaciones externas">
          <img src="assets/images/copy.png" alt="Listado de organización externa">
        </button>
      </div>
    </fieldset>

    <!-- Organizaciones seleccionadas -->
    <app-selected-organizations 
      *ngIf="eventForm.get('externalOrgParticipation')?.value && selectedOrganizations.length > 0"
      [selectedOrganizations]="selectedOrganizations"
      [initialOrganizationData]="initialOrgData"
      (organizationRemoved)="onOrganizationRemoved($event)">
    </app-selected-organizations>
    
    <!-- Mensaje cuando no hay organizaciones seleccionadas -->
    <div *ngIf="eventForm.get('externalOrgParticipation')?.value && selectedOrganizations.length === 0" class="no-organizations-selected">
      <p>No hay organizaciones seleccionadas. Haz clic en el botón de arriba para seleccionar organizaciones.</p>
    </div>
  </section>

  <div class="form-actions">
    <button type="submit" class="btn btn-primary" [disabled]="eventForm.invalid || encounters.length === 0 ">{{ isEdit ? 'Guardar cambios' : 'Crear' }}</button>
    <button type="button" class="btn btn-secondary" (click)="cancel()">Cancelar</button>
  </div>
</form>

<!-- Modal de organizaciones externas -->
<app-organizacion-externa 
  [showModal]="showOrgModal"
  (modalClosed)="closeOrgModal()"
  (organizationSelected)="onOrganizationSelected($event)">
</app-organizacion-externa>

<!-- Modal de selección de usuarios -->
<app-usuario-selection 
  [showModal]="showUserModal"
  [currentUserId]="currentUser?.idUsuario"
  (modalClosed)="closeUserModal()"
  (usuarioSelected)="onUserSelected($event)">
</app-usuario-selection>