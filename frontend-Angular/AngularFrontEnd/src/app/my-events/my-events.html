<header class="headerSec">
    <img src="assets/images/U_events.png" alt="Logo" class="logo-img" routerLink="/home">
  <h1>Mis Eventos</h1> 
  <div class="header-actions">
    <button class="btn-create-event" routerLink="/add-event">+ Crear evento</button>
    <i class="ri-account-circle-fill" id="perfilBtn" routerLink="/profile-menu"></i>
  </div>
</header>

<div class="container my-events-container">
  
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-message">
    <p>Cargando eventos...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-message">
    <p>{{ error }}</p>
    <button class="btn btn-primary" (click)="loadEvents()">Reintentar</button>
  </div>

  <!-- No Events State -->
  <div *ngIf="!loading && !error && events.length === 0" class="no-events-message">
    <p>No tienes eventos creados. ¡Crea uno nuevo!</p>
    <button class="btn btn-primary" routerLink="/add-event">+ Crear Evento</button>
  </div>

  <!-- Events Content -->
  <div *ngIf="!loading && !error && events.length > 0">
    
    <!-- Filtros -->
    <div class="filters-section">
      <button class="btn btn-outline-primary" (click)="toggleFilters()">
        {{ showFilters ? 'Ocultar Filtros' : 'Mostrar Filtros' }}
      </button>
      
      <div class="filters-container" [class.show]="showFilters">
        <div class="filter-group">
          <label for="filterEstado">Filtrar por Estado:</label>
          <select id="filterEstado" [(ngModel)]="filterEstado" (change)="applyFilters()">
            <option value="">Todos los estados</option>
            <option value="Borrador">Borrador</option>
            <option value="Pendiente">Pendiente</option>
            <option value="Aprobado">Aprobado</option>
            <option value="Rechazado">Rechazado</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="filterNombre">Filtrar por Nombre:</label>
          <input type="text" id="filterNombre" [(ngModel)]="filterNombre" 
                 (input)="applyFilters()" placeholder="Buscar por nombre del evento">
        </div>
        
        <div class="filter-group">
          <label for="filterFecha">Filtrar por Fecha:</label>
          <input type="date" id="filterFecha" [(ngModel)]="filterFecha" 
                 (change)="applyFilters()">
        </div>
        
        <button class="btn btn-secondary" (click)="clearFilters()">
          <i class="ri-eraser-fill"></i>
          <i>Limpiar filtros</i></button>
      </div>
    </div>
    
    <!-- Eventos en Borrador -->
    <div *ngIf="draftEvents.length > 0">
      <h2>Mis Eventos en Borrador</h2>
      <div *ngFor="let event of draftEvents" [class]="getEstadoCardClass(event.estado)">
        <div [class]="getEstadoBadgeClass(event.estado)">{{ event.estado }}</div>
        <h3>{{ event.titulo }}</h3>
        <p><strong>Tipo:</strong> {{ event.tipoEvento }}</p>
        <p><strong>Fecha:</strong> {{ event.fecha }}</p>
        <p><strong>Hora inicio:</strong> {{ event.horaInicio }}</p>
        <p><strong>Hora fin:</strong> {{ event.horaFin }}</p>
        
        <div class="event-actions">
          <button *ngIf="canSendToValidation(event)" 
                  class="btn btn-primary btn-sm" 
                  (click)="openConfirmModal(event)">
            Enviar a Validación
          </button>
          <button *ngIf="canEdit(event)" 
                  class="btn btn-secondary btn-sm" 
                  (click)="editEvent(event)">
            Editar Evento
          </button>
          <button *ngIf="canDelete(event)" 
                  class="btn btn-danger btn-sm" 
                  (click)="deleteEvent(event)">
            Eliminar
          </button>
        </div>
      </div>
    </div>

    <!-- Eventos Pendientes -->
    <div *ngIf="pendingEvents.length > 0">
      <h2>Mis Eventos Pendientes de Validación</h2>
      <div *ngFor="let event of pendingEvents" [class]="getEstadoCardClass(event.estado)">
        <div [class]="getEstadoBadgeClass(event.estado)">{{ event.estado }}</div>
        <h3>{{ event.titulo }}</h3>
        <p><strong>Tipo:</strong> {{ event.tipoEvento }}</p>
        <p><strong>Fecha:</strong> {{ event.fecha }}</p>
        <p><strong>Hora inicio:</strong> {{ event.horaInicio }}</p>
        <p><strong>Hora fin:</strong> {{ event.horaFin }}</p>
        
        <div class="event-actions">
          <button id='editarBtn' *ngIf="canEdit(event)" 
                  class="btn btn-secondary btn-sm" 
                  (click)="editEvent(event)">
            Editar Evento
          </button>
          <button *ngIf="canDelete(event)" 
                  class="btn btn-danger btn-sm" 
                  (click)="deleteEvent(event)">
            Eliminar
          </button>
        </div>
      </div>
    </div>


    <!-- Eventos Rechazados -->
    <div *ngIf="rejectedEvents.length > 0">
      <h2>Mis Eventos Rechazados</h2>
      <div *ngFor="let event of rejectedEvents" [class]="getEstadoCardClass(event.estado)">
        <div [class]="getEstadoBadgeClass(event.estado)">{{ event.estado }}</div>
        <h3>{{ event.titulo }}</h3>
        <p><strong>Tipo:</strong> {{ event.tipoEvento }}</p>
        <p><strong>Fecha:</strong> {{ event.fecha }}</p>
        <p><strong>Hora inicio:</strong> {{ event.horaInicio }}</p>
        <p><strong>Hora fin:</strong> {{ event.horaFin }}</p>
        
        <div class="event-actions">
          <button class="btn btn-info btn-sm" (click)="verJustificacion(event)">
            <i class="ri-file-text-line"></i> Ver Justificación
          </button>
          <button *ngIf="canSendToValidation(event)" 
                  class="btn btn-primary btn-sm" 
                  (click)="openConfirmModal(event)">
            Enviar a Validación
          </button>
          <button *ngIf="canEdit(event)" 
                  class="btn btn-secondary btn-sm" 
                  (click)="editEvent(event)">
            Editar Evento
          </button>
          <button *ngIf="canDelete(event)" 
                  class="btn btn-danger btn-sm" 
                  (click)="deleteEvent(event)">
            Eliminar
          </button>
        </div>
      </div>
    </div>

    <!-- Eventos Aprobados -->
    <div *ngIf="approvedEvents.length > 0">
      <h2>Mis Eventos Aprobados</h2>
      <div *ngFor="let event of approvedEvents" [class]="getEstadoCardClass(event.estado)">
        <div [class]="getEstadoBadgeClass(event.estado)">{{ event.estado }}</div>
        <h3>{{ event.titulo }}</h3>
        <p><strong>Tipo:</strong> {{ event.tipoEvento }}</p>
        <p><strong>Fecha:</strong> {{ event.fecha }}</p>
        <p><strong>Hora inicio:</strong> {{ event.horaInicio }}</p>
        <p><strong>Hora fin:</strong> {{ event.horaFin }}</p>
        
        <div class="event-actions">
          <button class="btn btn-success btn-sm" (click)="verActa(event)">
            <i class="ri-file-pdf-line"></i> Ver Acta
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal de confirmación para enviar a validación -->
<div class="modal fade" [class.show]="showConfirmModal" [style.display]="showConfirmModal ? 'block' : 'none'" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmación</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="cancelSend()"></button>
      </div>
      <div class="modal-body">
        <p>¿Quieres enviar el evento <strong>{{ eventToSend?.titulo }}</strong> a validación?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelSend()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="confirmSend()">Aceptar</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showConfirmModal" *ngIf="showConfirmModal"></div>

<!-- Modal para ver justificación de rechazo -->
<div class="modal fade" [class.show]="showJustificacionModal" [style.display]="showJustificacionModal ? 'block' : 'none'" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Justificación del Rechazo</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeJustificacionModal()"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="loadingEvaluacion" class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>
        <p *ngIf="!loadingEvaluacion">{{ justificacionTexto }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeJustificacionModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showJustificacionModal" *ngIf="showJustificacionModal"></div>

<!-- Modal para ver acta de aprobación -->
<div class="modal fade" [class.show]="showActaModal" [style.display]="showActaModal ? 'block' : 'none'" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Acta de Aprobación</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeActaModal()"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="loadingEvaluacion" class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>
        <div *ngIf="!loadingEvaluacion && actaUrl" class="text-center">
          <p>El acta del comité está disponible para visualización.</p>
          <iframe [src]="actaUrl" width="100%" height="500px" frameborder="0"></iframe>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" (click)="descargarActa()">
          <i class="ri-download-line"></i> Descargar Acta
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeActaModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showActaModal" *ngIf="showActaModal"></div>